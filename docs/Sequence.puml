@startuml
actor 사용자
participant "API 게이트웨이" as API
participant "대기열" as 대기열
participant "예약" as 예약
participant "좌석 락" as 락
participant "잔액" as 잔액
participant "결제" as 결제

== 대기열 등록 ==
사용자 -> API : 대기열 등록 요청 (/queue/token)
API -> 잔액 : 잔액 확인
잔액 --> API : 충분함
API -> 대기열 : 대기열 등록
대기열 --> API : 대기열 토큰 발급
API --> 사용자 : 토큰 전달

== 대기 상태 확인 ==
사용자 -> API : 대기 상태 조회 요청
API -> 대기열 : 대기 순번 조회
대기열 --> API : 순번 정보
API --> 사용자 : 순번 전달

== 좌석 예약 요청 ==
사용자 -> API : 좌석 예약 요청 (날짜 + 최대 4석)
API -> 대기열 : 토큰 유효성 검증
대기열 --> API : 유효함
API -> 락 : 좌석 임시 점유 요청 (3분 타이머 시작)
락 --> API : 점유 성공
API -> 예약 : 임시 예약 등록
예약 --> API : 등록 완료
API --> 사용자 : 임시 예약 완료 응답

== 결제 처리 ==
사용자 -> API : 결제 요청
API -> 대기열 : 토큰 유효성 확인
대기열 --> API : 유효함
API -> 잔액 : 잔액 차감 요청
잔액 --> API : 차감 완료
API -> 결제 : 결제 내역 생성
결제 -> 예약 : 좌석 소유권 확정
예약 -> 락 : 임시 점유 → 확정 처리
결제 -> 대기열 : 토큰 만료 처리
API --> 사용자 : 결제 완료 응답

@enduml